(function(e,t){"use strict";function n(){this.addCompilers()}function i(){return f++}function r(t){return r.enabled(t)?function(n){var i=Array.prototype.slice.call(arguments),o=new Date,s=o-(r[t]||o);r[t]=o,i[0]=t+" - "+n+" +"+r.humanize(s),e.console&&console.log&&Function.prototype.apply.call(console.log,console,i)}:function(){}}function o(e,t){function i(n,i){var r=n+"/"+i;o('loading resource "'+i+'" from '+r);var s=e.defer();return t.get(r).then(function(e){s.resolve(e.data)}),s.promise}var o=r("ngw:resources");this.load=function(t,n){var r=[],o=[];return m(n,function(e,n){r.push(n),o.push(i(t,e))}),e.all(o).then(function(e){var t={};return m(e,function(e,n){t[r[n]]=e}),t})};var s=new n;this.loadViewAndStyle=function(t){function n(t,n){var i=e.defer();return s.compile("less","#"+t+" { "+n+" }",function(e,t){e&&console.error(e),i.resolve(t)}),i.promise}return this.load(t.location,{view:"view.html",style:"style.less"}).then(function(i){var r=e.defer();return n(t.id,i.style).then(function(e){i.style=e,r.resolve(i)}),r.promise}).then(function(e){v(t,e)})}}function s(){function e(e,t,n){n||(n=t,t=null);var i=function r(t){return this instanceof r?(a.call(this,t),this.widgetName=e,this):new r(t)};return v(i,a,{widgetName:e}),v(i.prototype,a.prototype,n),t&&(i.settings=t,i.prototype.settings=t),i}function t(t,n,i){g.push(function(r){return r.when(e(t,n,i))})}function n(e,t){var n=[];return m(g,function(i){n.push(i(e,t))}),e.all(n)}function i(e){if(!e)return null;h(e)||(e=[e]);var t=[];return m(e,function(e){this.push({type:e.constructor.widgetName,data:e.toObject()})},t),t}function s(e){if(!e)return null;h(e)||(e=[e]);var t=[];return m(e,function(e){var t=p[e.type];return t?this.push(new t(e.data)):console.error("Unknown widget: "+e.type)},t),t}function c(e,t,r){function a(t,n){h(n)||(n=[]),_.forEach(n,function(n){w(n)&&Object.defineProperty(t,n,{get:function(){return e.get(n)},set:function(){},enumerable:!1,configurable:!0})})}var c=new o(t,r),d=n(t,r).then(function(e){m(e,function(e){e&&(f.push(e),p[e.widgetName]=e)})},function(e){console.err("widgets load failed: "+e)});return v(u,{ready:d,definitions:f,widget:function(e,t){if(t||(t=e,e=t.widgetName),!e)throw Error("Invalid arguments for create widget",arguments);var n=p[e];if(!n)return console.error("Unknown widget: "+e);var i=new n(t);return a(i,l.$widgetInjects),i},loadResources:function(e){h(e)||(e=[e]);var n=[];return m(e,function(e){n.push(c.loadViewAndStyle(e))}),t.all(n).then(function(){return e})},pack:i,unpack:s}),u}var d=r("ngw:widgets-service"),l=this,u={},g=[],f=[],p={};l.WidgetClass=a,l.$widgetInjects=[],this.define=t,this.load=function(t,n){n||(n=t),g.push(function(i,r){var o,s=i.defer();return r.get(n+"/widget.js").success(function(i){d("loaded widget: "+n);var r=Function("define",i);r(function(i,r){return r||(r=i,i={}),o=e(t,i,r),o.location=n,o.prototype.location=n,o}),s.resolve(o)}).error(function(){console.err("Could not load widget: "+n),s.resolve()}),s.promise})},this.pack=i,this.unpack=s,this.extend=function(e){v(u,e)},this.$get=c,c.$inject=["$injector","$q","$http"]}function a(e){this.id="widget-"+i(),this._initProperties(e)}function c(e){var t=r("ngw:draggabilly");return{restrict:"A",link:function(n,i){var r=null,o=function(){r=new Draggabilly(i[0],{handle:".drag-handle"}),r.on("dragEnd",function(){t("drag end")})},s="screen and (min-width: 480px)";enquire.register(s,{match:function(){r.enable(),t("matched")},unmatch:function(){r.disable(),t("unmatched")},deferSetup:!1,setup:function(){o(),t("setup"),enquire.queries[s].mql.matches||r.disable()}}),e.$broadcast(":draggabilly",r),e.$on(":undraggable",function(){r.disable()}),e.$on(":draggable",function(){r.enable()})}}}function d(e,t){var n,i=r("ngw:packery");return{restrict:"A",link:function(r,o,s){function a(){i("init"),n=new Packery(o[0],{itemSelector:s.ngwPackery,columnWidth:250,rowHeight:210,gutter:15,isInitLayout:!1}),n.on("layoutComplete",function(){}),n.on("dragItemPositioned",function(t,n){i("widgets order changed"),r.$$phase||r.$apply(function(){var n=t.items,i=[];m(n,function(e){i.push(e.element.id)}),e.$broadcast(":widgetsReordered",i)}),e.$broadcast(":widgetsOrderUpdated",n)})}function c(){n&&(i("refreshing"),n.reloadItems(),n.layout(),o.find(s.ngwPackery).css({opacity:1}))}function d(){n&&n.destroy&&(i("destroy"),n.destroy()),n=null,o.find(s.ngwPackery).css({top:"auto",left:"auto",position:"relative",opacity:1})}function l(){t(function(){o.find(s.ngwPackery).css({opacity:1})},0)}var u="screen and (min-width: 480px)";enquire.register(u,{match:function(){i("matched"),a(),c(),e.$broadcast(":draggable")},unmatch:function(){t(function(){d(),i("unmatched"),o.find(s.ngwPackery).css({top:"",left:"",position:"relative",opacity:1}),e.$broadcast(":undraggable")},100)},deferSetup:!1,setup:function(){i("setup"),enquire.queries[u].mql.matches?a():(l(),e.$broadcast(":undraggable"))}}),e.$on(":widgetsLoaded",function(){enquire.queries[u].mql.matches?c():l()}),e.$on(":draggabilly",function(e,t){n&&n.bindDraggabillyEvents(t)}),e.$on(":layoutChanged",function(){t(function(){c()},500)}),e.$on(":packeryDestroy",function(){d()})}}}function l(e){return{restrict:"A",link:function(n,i){var r=t(i),o=r.width(),s=r.height(),a=15;n.$watch("widget.settings.sizeX",function(t){i.width(o*t+a*(t-1)),e.$broadcast(":layoutChanged")}),n.$watch("widget.settings.sizeY",function(t){i.height(s*t+a*(t-1)),e.$broadcast(":layoutChanged")})}}}function u(e,n,i,r,o){return{template:n.get("widget.html"),replace:!0,restrict:"EA",link:function(n,s){var a=t(s),c=s.find(".x-widget-body"),d=n.widget;_.extend(n,n.$parent.defaults),n.style=i.trustAsHtml(d.style),a.attr("id",d.id),a.width(n.width),a.height(n.height),n.bodyCls&&c.addClass(n.bodyCls),n.updateBodyHTML=function(){c.empty(),n.HTML=d.view;var e;try{e=angular.element(n.HTML)}catch(t){e=angular.element("<div>"+n.HTML+"</div>")}c.html(r(e)(n))},n.run=function(){d.run({scope:n,element:c})},n.toolOnClick=function(e,t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),p(e.handler)&&e.handler(t,n)},n.deleteWidget=function(){n.$parent.deleteWidget(d)},n.$on(":widgetSelect",function(t,i){n.selected=!1,i.id===n.widget.id&&(n.selected=!n.selected,e.$broadcast(n.selected?":widgetSelected":":widgetDeselected",i))}),o(function(){n.updateBodyHTML(),n.run(),n.$apply()})}}}function g(e,t,n){var i=r("ngw:widgets-directive");return{template:t.get("widgets.html"),replace:!0,restrict:"EA",scope:!0,link:function(t,r,o){function s(i){t.widgets=i,n(function(){e.$broadcast(":widgetsLoaded",t.widgets)})}console.log("widgets directive link");var a=t.$eval(o.ngwWidgets);a&&(t.defaults=v({width:250,height:210,cls:"x-panel-default",selectedCls:"x-panel-selected"},a.defaults),"string"==typeof a.widgets?t.$parent.$watch(a.widgets,function(e){s(e)}):s(a.widgets),t.selectWidget=function(t){i("selecting widget #"+t.id,t),e.$broadcast(":widgetSelect",t)},t.deleteWidget=function(r){i("deleting widget #"+r.id),t.widgets.splice(t.widgets.indexOf(r),1),e.$broadcast(":widgetDeleted",r,t.widgets),n(function(){e.$broadcast(":widgetsLoaded",t.widgets)})})}}}n.prototype.compile=function(e,t,n){n||(n=function(){});var i=this.getCompiler(e);if(!i)return n();var r={}||i.options;return i.render(t,r,function(e,t){return e?n(e):n(null,t)}),!0},n.prototype.getCompiler=function(e){var t;return(t=this.compilers[e])||console.log("AssetsCompiler: Compiler "+e+" not implemented"),t},n.prototype.hasCompiler=function(e){return!!this.compilers[e]},n.prototype.compilers={},n.prototype.add=function(e,t){var n=this;return e=e instanceof Array?e:[e],e.forEach(function(e){n.compilers[e]={},n.configure(e,t)}),this},n.prototype.configure=function(e,t){var n,i=this.compilers[e];if(i)for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n]);return this},n.prototype.addCompilers=function(){var e=this;e.add("less",{render:function(e,t,n){this.less=this.less||less;try{var i=new this.less.Parser;i.parse(e,function(e,t){if(e)throw e;n(null,t.toCSS())})}catch(r){n(r)}}})};var f=0,p=(angular.isDefined,angular.isFunction),w=angular.isString,h=(angular.isObject,angular.isArray),m=angular.forEach,v=angular.extend,y=(angular.copy,angular.noop);angular.module("ng.widgets.directives",[]),angular.module("ng.widgets.services",[]),angular.module("ng.widgets",["ng.widgets.directives","ng.widgets.services"]),r.names=[],r.skips=[],r.enable=function(e){try{localStorage.debug=e}catch(t){}for(var n=(e||"").split(/[\s,]+/),i=n.length,o=0;i>o;o++)e=n[o].replace("*",".*?"),"-"===e[0]?r.skips.push(RegExp("^"+e.substr(1)+"$")):r.names.push(RegExp("^"+e+"$"))},r.disable=function(){r.enable("")},r.humanize=function(e){var t=1e3,n=6e4,i=60*n;return e>=i?(e/i).toFixed(1)+"h":e>=n?(e/n).toFixed(1)+"m":e>=t?(0|e/t)+"s":e+"ms"},r.enabled=function(e){for(var t=0,n=r.skips.length;n>t;t++)if(r.skips[t].test(e))return!1;for(var t=0,n=r.names.length;n>t;t++)if(r.names[t].test(e))return!0;return!1},e.localStorage&&r.enable(localStorage.debug),angular.module("ng.widgets.services").provider("$widgets",s),a.prototype._initProperties=function(e){v(this,e)},a.prototype.run=function(e){v(this,e),this.beforeWidgetize(),this.widgetize(),this.afterWidgetize()},a.prototype.beforeWidgetize=y,a.prototype.widgetize=y,a.prototype.afterWidgetize=y,a.prototype.toObject=function(){return{}},a.extend=function(e){v(a.prototype,e)},c.$inject=["$rootScope"],angular.module("ng.widgets.directives").directive("ngwDraggabilly",c),d.$inject=["$rootScope","$timeout"],angular.module("ng.widgets.directives").directive("ngwPackery",d),l.$inject=["$rootScope"],angular.module("ng.widgets.directives").directive("ngwSizable",l),u.$inject=["$rootScope","$templateCache","$sce","$compile","$timeout"],angular.module("ng.widgets.directives").directive("ngwWidget",u),g.$inject=["$rootScope","$templateCache","$timeout"],angular.module("ng.widgets.directives").directive("ngwWidgets",g),angular.module("ng.widgets").run(["$templateCache",function(e){e.put("widget.html",'<div class="x-panel" ng-class="selected ? selectedCls : cls">\n    <div class="x-widget-header x-panel-header drag-handle" ng-click="selectWidget(widget)">\n        <div class="widget-title-icon">\n            <i class="{{widget.settings.icon}}"/>\n        </div>\n        <h1>{{widget.settings.name}}</h1>\n\n        <div class="x-tools x-pull-right">\n            <span class="x-tool"\n                  ng-class="tool.iconCls || \'\'"\n                  ng-click="toolOnClick(tool, $event)"\n                  ng-repeat="tool in tools">\n            </span>\n\n        </div>\n    </div>\n    <div class="x-widget-body x-panel-body" ng-bind-html="view"></div>\n    <style type="text/css" ng-bind-html="style"></style>\n</div>\n\n'),e.put("widgets.html",'<section id="widgets-container" class="x-widgets-container meticulous clearfix">\n    <div ngw-packery=".x-widget" class="widgets packery">\n        <div class="x-widget" ngw-widget ngw-draggabilly ngw-sizable ng-repeat="widget in widgets"></div>\n    </div>\n</section>')}])})(window,jQuery);
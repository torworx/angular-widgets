(function(e,t){"use strict";function n(){this.addCompilers()}function i(){return p++}function r(e){return m(arguments,function(t){t!==e&&m(t,function(t,n){e.hasOwnProperty(n)||(e[n]=t)})}),e}function o(t){return o.enabled(t)?function(n){var i=Array.prototype.slice.call(arguments),r=new Date,a=r-(o[t]||r);o[t]=r,i[0]=t+" - "+n+" +"+o.humanize(a),e.console&&console.log&&Function.prototype.apply.call(console.log,console,i)}:function(){}}function a(e,t){function i(n,i){var o=n+"/"+i;r('loading resource "'+i+'" from '+o);var a=e.defer();return t.get(o).then(function(e){a.resolve(e.data)}),a.promise}var r=o("ngw:resources");this.load=function(t,n){var r=[],o=[];return m(n,function(e,n){r.push(n),o.push(i(t,e))}),e.all(o).then(function(e){var t={};return m(e,function(e,n){t[r[n]]=e}),t})};var a=new n;this.loadViewAndStyle=function(t){function n(t,n){var i=e.defer();return a.compile("less","#"+t+" { "+n+" }",function(e,t){e&&console.error(e),i.resolve(t)}),i.promise}return this.load(t.location,{view:"view.html",style:"style.less"}).then(function(i){var r=e.defer();return n(t.id,i.style).then(function(e){i.style=e,r.resolve(i)}),r.promise}).then(function(e){v(t,e)})}}function s(){function e(e,t,n){n||(n=t,t=null);var i=function r(t){return this instanceof r?(c.call(this,t),this.widgetName=e,this):new r(t)};return v(i,c,{widgetName:e}),v(i.prototype,c.prototype,n),t&&(i.settings=t,i.prototype.settings=t),i}function t(t,n,i){u.push(function(r){return r.when(e(t,n,i))})}function n(e,t){var n=[];return m(u,function(i){n.push(i(e,t))}),e.all(n)}function i(e){if(!e)return null;h(e)||(e=[e]);var t=[];return m(e,function(e){this.push({type:e.constructor.widgetName,data:e.toObject()})},t),t}function r(e){if(!e)return null;h(e)||(e=[e]);var t=[];return m(e,function(e){var t=f[e.type];return t?this.push(new t(e.data)):console.error("Unknown widget: "+e.type)},t),t}function s(e,t){var o=new a(e,t),s=n(e,t).then(function(e){m(e,function(e){e&&(g.push(e),f[e.widgetName]=e)})},function(e){console.err("widgets load failed: "+e)});return v(l,{ready:s,definitions:g,widget:function(e,t){if(t||(t=e,e=t.widgetName),!e)throw Error("Invalid arguments for create widget",arguments);var n=f[e];return n?new n(t):console.error("Unknown widget: "+e)},loadResources:function(t){h(t)||(t=[t]);var n=[];return m(t,function(e){n.push(o.loadViewAndStyle(e))}),e.all(n).then(function(){return t})},pack:i,unpack:r}),l}var d=o("ngw:widgets-service"),l={},u=[],g=[],f={};this.WidgetClass=c,this.define=t,this.load=function(t,n){n||(n=t),u.push(function(i,r){var o,a=i.defer();return r.get(n+"/widget.js").success(function(i){d("loaded widget: "+n);var r=Function("define",i);r(function(i,r){return r||(r=i,i={}),o=e(t,i,r),o.location=n,o.prototype.location=n,o}),a.resolve(o)}).error(function(){console.err("Could not load widget: "+n),a.resolve()}),a.promise})},this.pack=i,this.unpack=r,this.extend=function(e){v(l,e)},this.$get=s,s.$inject=["$q","$http"]}function c(e){this.id="widget-"+i(),this._initProperties(e)}function d(e){var t=o("ngw:draggabilly");return{restrict:"A",link:function(n,i){var r=null,o=function(){r=new Draggabilly(i[0],{handle:".drag-handle"}),r.on("dragEnd",function(){t("drag end")})},a="screen and (min-width: 480px)";enquire.register(a,{match:function(){r.enable(),t("matched")},unmatch:function(){r.disable(),t("unmatched")},deferSetup:!1,setup:function(){o(),t("setup"),enquire.queries[a].mql.matches||r.disable()}}),e.$broadcast(":draggabilly",r),e.$on(":undraggable",function(){r.disable()}),e.$on(":draggable",function(){r.enable()})}}}function l(e,t){var n,i=o("ngw:packery");return{restrict:"A",link:function(r,o,a){function s(){i("init"),n=new Packery(o[0],{itemSelector:a.ngwPackery,columnWidth:250,rowHeight:210,gutter:20,isInitLayout:!1}),n.on("layoutComplete",function(){}),n.on("dragItemPositioned",function(t,n){i("widgets order changed"),r.$$phase||r.$apply(function(){var n=t.items,i=[];m(n,function(e){i.push(e.element.id)}),e.$broadcast(":widgetsReordered",i)}),e.$broadcast(":widgetsOrderUpdated",n)})}function c(){n&&(i("refreshing"),n.reloadItems(),n.layout(),o.find(a.ngwPackery).css({opacity:1}))}function d(){n&&n.destroy&&(i("destroy"),n.destroy()),n=null,o.find(a.ngwPackery).css({top:"auto",left:"auto",position:"relative",opacity:1})}function l(){t(function(){o.find(a.ngwPackery).css({opacity:1})},0)}var u="screen and (min-width: 480px)";enquire.register(u,{match:function(){i("matched"),s(),c(),e.$broadcast(":draggable")},unmatch:function(){t(function(){d(),i("unmatched"),o.find(a.ngwPackery).css({top:"",left:"",position:"relative",opacity:1}),e.$broadcast(":undraggable")},100)},deferSetup:!1,setup:function(){i("setup"),enquire.queries[u].mql.matches?s():(l(),e.$broadcast(":undraggable"))}}),e.$on(":widgetsLoaded",function(){enquire.queries[u].mql.matches?c():l()}),e.$on(":draggabilly",function(e,t){n&&n.bindDraggabillyEvents(t)}),e.$on(":layoutChanged",function(){t(function(){c()},500)}),e.$on(":packeryDestroy",function(){d()})}}}function u(e){return{restrict:"A",link:function(n,i){var r=t(i),o=r.width(),a=r.height(),s=20;n.$watch("widget.settings.sizeX",function(t){i.width(o*t+s*(t-1)),e.$broadcast(":layoutChanged")}),n.$watch("widget.settings.sizeY",function(t){i.height(a*t+s*(t-1)),e.$broadcast(":layoutChanged")})}}}function g(e,n,i,r,o){return{template:n.get("widget.html"),replace:!0,restrict:"EA",link:function(n,a){var s=t(a),c=a.find(".x-widget-body"),d=n.widget;n.style=i.trustAsHtml(d.style),s.attr("id",d.id),s.width(d.width),s.height(d.height),d.bodyCls&&c.addClass(d.bodyCls),n.updateBodyHTML=function(){c.empty(),n.HTML=d.view;var e;try{e=angular.element(n.HTML)}catch(t){e=angular.element("<div>"+n.HTML+"</div>")}c.html(r(e)(n))},n.run=function(){d.run({scope:n,element:c,$timeout:o})},n.toolOnClick=function(e,t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),w(e.handler)&&e.handler(t,n)},n.deleteWidget=function(){n.$parent.deleteWidget(d)},n.$on(":widgetSelect",function(t,i){n.selected=!1,i.id===n.widget.id&&(n.selected=!n.selected,e.$broadcast(n.selected?":widgetSelected":":widgetDeselected",i))}),o(function(){n.updateBodyHTML(),n.run(),n.$apply()})}}}function f(e,t,n){var i=o("ngw:widgets-directive");return{template:t.get("widgets.html"),replace:!0,restrict:"EA",scope:!0,link:function(t,o,a){function s(i){t.widgets=i,angular.forEach(i,function(e){r(e,d),v(e,c.widget)}),n(function(){e.$broadcast(":widgetsLoaded",t.widgets)})}console.log("widgets directive link");var c=t.$eval(a.ngwWidgets);if(c){var d=v({width:250,height:210,cls:"x-panel-default",selectedCls:"x-panel-selected"},c.defaults||{});"string"==typeof c.widgets?t.$parent.$watch(c.widgets,function(e){s(e)}):s(c.widgets),t.selectWidget=function(t){i("selecting widget #"+t.id,t),e.$broadcast(":widgetSelect",t)},t.deleteWidget=function(r){i("deleting widget #"+r.id),t.widgets.splice(t.widgets.indexOf(r),1),e.$broadcast(":widgetDeleted",r,t.widgets),n(function(){e.$broadcast(":widgetsLoaded",t.widgets)})}}}}}n.prototype.compile=function(e,t,n){n||(n=function(){});var i=this.getCompiler(e);if(!i)return n();var r={}||i.options;return i.render(t,r,function(e,t){return e?n(e):n(null,t)}),!0},n.prototype.getCompiler=function(e){var t;return(t=this.compilers[e])||console.log("AssetsCompiler: Compiler "+e+" not implemented"),t},n.prototype.hasCompiler=function(e){return!!this.compilers[e]},n.prototype.compilers={},n.prototype.add=function(e,t){var n=this;return e=e instanceof Array?e:[e],e.forEach(function(e){n.compilers[e]={},n.configure(e,t)}),this},n.prototype.configure=function(e,t){var n,i=this.compilers[e];if(i)for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n]);return this},n.prototype.addCompilers=function(){var e=this;e.add("less",{render:function(e,t,n){this.less=this.less||less;try{var i=new this.less.Parser;i.parse(e,function(e,t){if(e)throw e;n(null,t.toCSS())})}catch(r){n(r)}}})};var p=0,w=(angular.isDefined,angular.isFunction),h=(angular.isString,angular.isObject,angular.isArray),m=angular.forEach,v=angular.extend,y=(angular.copy,angular.noop);angular.module("ng.widgets.directives",[]),angular.module("ng.widgets.services",[]),angular.module("ng.widgets",["ng.widgets.directives","ng.widgets.services"]),o.names=[],o.skips=[],o.enable=function(e){try{localStorage.debug=e}catch(t){}for(var n=(e||"").split(/[\s,]+/),i=n.length,r=0;i>r;r++)e=n[r].replace("*",".*?"),"-"===e[0]?o.skips.push(RegExp("^"+e.substr(1)+"$")):o.names.push(RegExp("^"+e+"$"))},o.disable=function(){o.enable("")},o.humanize=function(e){var t=1e3,n=6e4,i=60*n;return e>=i?(e/i).toFixed(1)+"h":e>=n?(e/n).toFixed(1)+"m":e>=t?(0|e/t)+"s":e+"ms"},o.enabled=function(e){for(var t=0,n=o.skips.length;n>t;t++)if(o.skips[t].test(e))return!1;for(var t=0,n=o.names.length;n>t;t++)if(o.names[t].test(e))return!0;return!1},e.localStorage&&o.enable(localStorage.debug),angular.module("ng.widgets.services").provider("$widgets",s),c.prototype._initProperties=function(e){v(this,e)},c.prototype.run=function(e){v(this,e),this.beforeWidgetize(),this.widgetize(),this.afterWidgetize()},c.prototype.beforeWidgetize=y,c.prototype.widgetize=y,c.prototype.afterWidgetize=y,c.prototype.toObject=function(){return{}},c.extend=function(e){v(c.prototype,e)},d.$inject=["$rootScope"],angular.module("ng.widgets.directives").directive("ngwDraggabilly",d),l.$inject=["$rootScope","$timeout"],angular.module("ng.widgets.directives").directive("ngwPackery",l),u.$inject=["$rootScope"],angular.module("ng.widgets.directives").directive("ngwSizable",u),g.$inject=["$rootScope","$templateCache","$sce","$compile","$timeout"],angular.module("ng.widgets.directives").directive("ngwWidget",g),f.$inject=["$rootScope","$templateCache","$timeout"],angular.module("ng.widgets.directives").directive("ngwWidgets",f),angular.module("ng.widgets").run(["$templateCache",function(e){e.put("widget.html",'<div class="x-panel" ng-class="selected ? widget.selectedCls : widget.cls">\n    <div class="x-widget-header x-panel-header drag-handle" ng-click="selectWidget(widget)">\n        <h1>{{widget.settings.name}}</h1>\n        <div class="x-tools x-pull-right">\n            <span class="x-tool"\n                  ng-class="tool.iconCls || \'\'"\n                  ng-click="toolOnClick(tool, $event)"\n                  ng-repeat="tool in widget.tools">\n            </span>\n\n        </div>\n    </div>\n    <div class="x-widget-body x-panel-body" ng-bind-html="view"></div>\n    <style type="text/css" ng-bind-html="style"></style>\n</div>\n\n'),e.put("widgets.html",'<section id="widgets-container" class="x-widgets-container meticulous clearfix">\n    <div ngw-packery=".x-widget" class="widgets packery">\n        <div class="x-widget" ngw-widget ngw-draggabilly ngw-sizable ng-repeat="widget in widgets"></div>\n    </div>\n</section>')}])})(window,jQuery);
(function(e,t){"use strict";function n(){this.addCompilers()}function i(){return f++}function o(e){return m(arguments,function(t){t!==e&&m(t,function(t,n){e.hasOwnProperty(n)||(e[n]=t)})}),e}function r(t){return r.enabled(t)?function(n){var i=Array.prototype.slice.call(arguments),o=new Date,a=o-(r[t]||o);r[t]=o,i[0]=t+" - "+n+" +"+r.humanize(a),e.console&&console.log&&Function.prototype.apply.call(console.log,console,i)}:function(){}}function a(e,t){var n=r("ngw:resources");this.load=function(i,o,r){var a,s,c=i[o],d=i[o+"Url"];return i.location&&(d=i.location+"/"+(d||r)),c?s=e.when(c):d&&(a=e.defer(),n('loading resource "'+o+'" from '+d),t.get(d).then(function(e){a.resolve(e.data)}),s=a.promise),s||e.when()}}function s(){function e(e,t,n){n||(n=t,t=null);var i=function o(e){return this instanceof o?(c.call(this,e),this):new o(e)};return v(i,c,{widgetName:e}),v(i.prototype,c.prototype,n),t&&(i.settings=t,i.prototype.settings=t),i}function t(t,n,i){g.push(function(o){return o.when(e(t,n,i))})}function i(e,t){function n(e){return function(n){var i=t.defer();return w.compile("less","#"+e+" { "+n+" }",function(e,t){e&&console.error(e),i.resolve(t)}),i.promise}}function i(e,t){return function(n){e[t]=n}}return function(){var o=this;if(!o._resready){var r=[];r.push(e.load(o,"view","view.html").then(i(o,"view"))),r.push(e.load(o,"style","style.less").then(n(o.id)).then(i(o,"style"))),o._resready=t.all(r)}return o._resready}}function o(e,t){var n=[];return m(g,function(i){n.push(i(e,t))}),e.all(n)}function s(e){if(!e)return null;h(e)||(e=[e]);var t=[];return m(e,function(e){this.push({type:e.constructor.widgetName,data:e.toObject()})},t),t}function d(e){if(!e)return null;h(e)||(e=[e]);var t=[];return m(e,function(e){var t=f[e.type];return t?this.push(new t(e.data)):console.error("Unknown widget: "+e.type)},t),t}function l(e,t){var n=new a(e,t),r=i(n,e),c=o(e,t).then(function(e){m(e,function(e){e&&(e.prototype.loadResources=r,p.push(e),f[e.widgetName]=e)})},function(e){console.err("widgets load failed: "+e)});return{ready:c,definitions:p,widget:function(e,t){var n=f[e];return n?new n(t):console.error("Unknown widget: "+e)},pack:s,unpack:d}}var u=r("ngw:widgets-service"),g=[],p=[],f={};this.WidgetClass=c,this.define=t,this.load=function(t,n){n||(n=t),g.push(function(i,o){var r,a=i.defer();return o.get(n+"/widget.js").success(function(i){u("loaded widget: "+n);var o=Function("define",i);o(function(i,o){return o||(o=i,i={}),r=e(t,i,o),r.location=n,r.prototype.location=n,r}),a.resolve(r)}).error(function(){console.err("Could not load widget: "+n),a.resolve()}),a.promise})};var w=new n;this.pack=s,this.unpack=d,this.$get=l,l.$inject=["$q","$http"]}function c(e){this.id="widget-"+i(),this._initProperties(e)}function d(e){var t=r("ngw:draggabilly");return{restrict:"A",link:function(n,i){var o=null,r=function(){o=new Draggabilly(i[0],{handle:".drag-handle"}),o.on("dragEnd",function(){t("drag end")})},a="screen and (min-width: 480px)";enquire.register(a,{match:function(){o.enable(),t("matched")},unmatch:function(){o.disable(),t("unmatched")},deferSetup:!1,setup:function(){r(),t("setup"),enquire.queries[a].mql.matches||o.disable()}}),e.$broadcast(":draggabilly",o),e.$on(":undraggable",function(){o.disable()}),e.$on(":draggable",function(){o.enable()})}}}function l(e,t){var n,i=r("ngw:packery");return{restrict:"A",link:function(o,r,a){function s(){i("init"),n=new Packery(r[0],{itemSelector:a.ngwPackery,columnWidth:250,rowHeight:210,gutter:20,isInitLayout:!1}),n.on("layoutComplete",function(){}),n.on("dragItemPositioned",function(t,n){i("widgets order changed"),o.$$phase||o.$apply(function(){var n=t.items,i=[];m(n,function(e){i.push(e.element.id)}),e.$broadcast(":widgetsReordered",i)}),e.$broadcast(":widgetsOrderUpdated",n)})}function c(){n&&(i("refreshing"),n.reloadItems(),n.layout(),r.find(a.ngwPackery).css({opacity:1}))}function d(){n&&n.destroy&&(i("destroy"),n.destroy()),n=null,r.find(a.ngwPackery).css({top:"auto",left:"auto",position:"relative",opacity:1})}function l(){t(function(){r.find(a.ngwPackery).css({opacity:1})},0)}var u="screen and (min-width: 480px)";enquire.register(u,{match:function(){i("matched"),s(),c(),e.$broadcast(":draggable")},unmatch:function(){t(function(){d(),i("unmatched"),r.find(a.ngwPackery).css({top:"",left:"",position:"relative",opacity:1}),e.$broadcast(":undraggable")},100)},deferSetup:!1,setup:function(){i("setup"),enquire.queries[u].mql.matches?s():(l(),e.$broadcast(":undraggable"))}}),e.$on(":widgetsLoaded",function(){enquire.queries[u].mql.matches?c():l()}),e.$on(":draggabilly",function(e,t){n&&n.bindDraggabillyEvents(t)}),e.$on(":layoutChanged",function(){t(function(){c()},500)}),e.$on(":packeryDestroy",function(){d()})}}}function u(e){return{restrict:"A",link:function(n,i){var o=t(i),r=o.width(),a=o.height(),s=20;n.$watch("widget.settings.sizeX",function(t){i.width(r*t+s*(t-1)),e.$broadcast(":layoutChanged")}),n.$watch("widget.settings.sizeY",function(t){i.height(a*t+s*(t-1)),e.$broadcast(":layoutChanged")})}}}function g(e,n,i,o){return{template:n.get("widget.html"),replace:!0,restrict:"EA",link:function(n,r){var a=t(r),s=r.find(".x-panel-body"),c=n.widget;n.title=c.name||c.settings.name,n.view=i.trustAsHtml(c.view),n.style=i.trustAsHtml(c.style),a.attr("id",c.id),a.width(c.width),a.height(c.height),c.bodyCls&&s.addClass(c.bodyCls),n.toolOnClick=function(e,t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),w(e.handler)&&e.handler(t,n)},n.deleteWidget=function(){n.$parent.deleteWidget(c)},o(function(){c.initialize({scope:n,element:s,$timeout:o}),c.widgetize()}),n.$on(":widgetSelect",function(t,i){n.selected=!1,i.id===n.widget.id&&(n.selected=!n.selected,e.$broadcast(n.selected?":widgetSelected":":widgetDeselected",i))})}}}function p(e,t,n){var i=r("ngw:widgets-directive");return{template:t.get("widgets.html"),replace:!0,restrict:"EA",scope:!0,link:function(t,r,a){function s(i){t.widgets=i,angular.forEach(i,function(e){o(e,d),v(e,c.widget)}),n(function(){e.$broadcast(":widgetsLoaded",t.widgets)})}console.log("widgets directive link");var c=t.$eval(a.ngwWidgets);if(c){var d=v({width:250,height:210,cls:"x-panel-default",selectedCls:"x-panel-selected"},c.defaults||{});"string"==typeof c.widgets?t.$parent.$watch(c.widgets,function(e){s(e)}):s(c.widgets),t.selectWidget=function(t){i("selecting widget #"+t.id,t),e.$broadcast(":widgetSelect",t)},t.deleteWidget=function(o){i("deleting widget #"+o.id),t.widgets.splice(t.widgets.indexOf(o),1),e.$broadcast(":widgetDeleted",o,t.widgets),n(function(){e.$broadcast(":widgetsLoaded",t.widgets)})}}}}}n.prototype.compile=function(e,t,n){n||(n=function(){});var i=this.getCompiler(e);if(!i)return n();var o={}||i.options;return i.render(t,o,function(e,t){return e?n(e):n(null,t)}),!0},n.prototype.getCompiler=function(e){var t;return(t=this.compilers[e])||console.log("AssetsCompiler: Compiler "+e+" not implemented"),t},n.prototype.hasCompiler=function(e){return!!this.compilers[e]},n.prototype.compilers={},n.prototype.add=function(e,t){var n=this;return e=e instanceof Array?e:[e],e.forEach(function(e){n.compilers[e]={},n.configure(e,t)}),this},n.prototype.configure=function(e,t){var n,i=this.compilers[e];if(i)for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n]);return this},n.prototype.addCompilers=function(){var e=this;e.add("less",{render:function(e,t,n){this.less=this.less||less;try{var i=new this.less.Parser;i.parse(e,function(e,t){if(e)throw e;n(null,t.toCSS())})}catch(o){n(o)}}})};var f=0,w=(angular.isDefined,angular.isFunction),h=(angular.isString,angular.isObject,angular.isArray),m=angular.forEach,v=angular.extend,y=(angular.copy,angular.noop);angular.module("ng.widgets.directives",[]),angular.module("ng.widgets.services",[]),angular.module("ng.widgets",["ng.widgets.directives","ng.widgets.services"]),r.names=[],r.skips=[],r.enable=function(e){try{localStorage.debug=e}catch(t){}for(var n=(e||"").split(/[\s,]+/),i=n.length,o=0;i>o;o++)e=n[o].replace("*",".*?"),"-"===e[0]?r.skips.push(RegExp("^"+e.substr(1)+"$")):r.names.push(RegExp("^"+e+"$"))},r.disable=function(){r.enable("")},r.humanize=function(e){var t=1e3,n=6e4,i=60*n;return e>=i?(e/i).toFixed(1)+"h":e>=n?(e/n).toFixed(1)+"m":e>=t?(0|e/t)+"s":e+"ms"},r.enabled=function(e){for(var t=0,n=r.skips.length;n>t;t++)if(r.skips[t].test(e))return!1;for(var t=0,n=r.names.length;n>t;t++)if(r.names[t].test(e))return!0;return!1},e.localStorage&&r.enable(localStorage.debug),angular.module("ng.widgets.services").provider("$widgets",s),c.prototype._initProperties=function(e){v(this,e)},c.prototype.initialize=function(e){v(this,e),this.afterInitialize()},c.prototype.widgetize=function(){this._widgetize(),this.afterWidgetize()},c.prototype.afterInitialize=y,c.prototype._widgetize=y,c.prototype.afterWidgetize=y,c.prototype.toObject=function(){return{}},c.extend=function(e){v(c.prototype,e)},d.$inject=["$rootScope"],angular.module("ng.widgets.directives").directive("ngwDraggabilly",d),l.$inject=["$rootScope","$timeout"],angular.module("ng.widgets.directives").directive("ngwPackery",l),u.$inject=["$rootScope"],angular.module("ng.widgets.directives").directive("ngwSizable",u),g.$inject=["$rootScope","$templateCache","$sce","$timeout"],angular.module("ng.widgets.directives").directive("ngwWidget",g),p.$inject=["$rootScope","$templateCache","$timeout"],angular.module("ng.widgets.directives").directive("ngwWidgets",p),angular.module("ng.widgets").run(["$templateCache",function(e){e.put("widget.html",'<div class="x-panel" ng-class="selected ? widget.selectedCls : widget.cls">\n    <div class="x-panel-header drag-handle" ng-click="selectWidget(widget)">\n        <h1>{{title}}</h1>\n        <div class="x-tools x-pull-right">\n            <span class="x-tool"\n                  ng-class="tool.iconCls || \'\'"\n                  ng-click="toolOnClick(tool, $event)"\n                  ng-repeat="tool in widget.tools">\n            </span>\n\n        </div>\n    </div>\n    <div class="x-panel-body" ng-bind-html="view"></div>\n    <style type="text/css" ng-bind-html="style"></style>\n</div>\n\n'),e.put("widgets.html",'<section id="widgets-container" class="x-widgets-container meticulous clearfix">\n    <div ngw-packery=".x-widget" class="widgets packery">\n        <div class="x-widget" ngw-widget ngw-draggabilly ngw-sizable ng-repeat="widget in widgets"></div>\n    </div>\n</section>')}])})(window,jQuery);